# 新功能总结

## ✅ 已实现的三个功能

### 1. 修复局域网视频加载问题

**问题**：局域网其他主机无法加载视频

**解决方案**：
```powershell
# 修改前
python -m http.server 8011 --directory .

# 修改后
python -m http.server 8011 --bind 0.0.0.0 --directory .
```

添加 `--bind 0.0.0.0` 参数，让视频服务器监听所有网络接口，不只是localhost。

**测试方法**：
1. 在服务器主机上启动服务
2. 在同一局域网的其他设备上访问评审员链接
3. 确认视频能正常播放

---

### 2. 返回上一题功能（支持重判）

**新增功能**：
- ✅ 添加"⬅️ 上一题"按钮
- ✅ 点击后进入重判模式
- ✅ 显示之前的选择
- ✅ 可以修改评分
- ✅ 修改后自动返回当前任务

**UI显示**：

**正常模式**：
```
[选择 视频A [A]] [选择 视频B [S]] [两者相当 [D]] [⬅️ 上一题]
```

**重判模式**：
```
[⬅️ 返回当前任务]  🔄 重判模式 | 之前选择：视频A

[选择 视频A [A]] [选择 视频B [S]] [两者相当 [D]]
```

**工作流程**：
1. 点击"上一题"按钮
2. 系统显示最近评测的任务
3. 显示之前的选择（如"之前选择：视频A"）
4. 评审员可以重新选择
5. 提交后自动删除旧记录，保存新记录
6. 自动返回当前未评任务

**数据库处理**：
- 重判时先删除旧的评测记录
- 然后插入新的评测记录
- 触发器自动更新任务的评测次数

---

### 3. 键盘快捷键

**快捷键映射**：
- **A键** → 选择视频A
- **S键** → 选择视频B
- **D键** → 两者相当

**UI提示**：
右下角固定显示：
```
┌────────────────────────────┐
│ 快捷键：A-视频A | S-视频B │
│         D-相当              │
└────────────────────────────┘
```

**按钮标签更新**：
- `选择 视频A [A]`
- `选择 视频B [S]`
- `两者相当 [D]`

**使用方法**：
1. 观看完视频后
2. 直接按键盘A/S/D键
3. 自动提交并跳转到下一题

**注意事项**：
- 只在没有焦点在输入框时响应
- 大小写不敏感（a/A都可以）
- 自动阻止默认行为

---

## 📊 完整的评测流程

### 正常评测流程
```
1. 打开评审员链接
2. 观看3个视频（自动播放）
3. 按A/S/D键或点击按钮选择
4. 自动提交，0.5秒后跳转
5. 继续评测下一个任务
```

### 重判流程
```
1. 点击"上一题"按钮
2. 查看之前的任务和选择
3. 重新做出选择
4. 提交后自动返回当前任务
```

---

## 🛠️ 技术实现

### 1. 视频服务器绑定

**文件**：`lan_start_compare.ps1`

```powershell
python -m http.server 8011 --bind 0.0.0.0 --directory .
```

### 2. 重判功能

**新增函数**：
- `get_current_task(judge_id, offset=0)` - 支持offset参数
- `delete_comparison(task_id, judge_id)` - 删除旧评测记录

**数据库查询**：
```sql
-- 获取上一个已评任务
SELECT ... FROM assignments a
JOIN comparisons c ON c.task_id = t.task_id AND c.judge_id = a.judge_id
WHERE a.judge_id = ?
ORDER BY c.rating_time DESC
LIMIT 1 OFFSET 0
```

### 3. 快捷键实现

**JavaScript代码**：
```javascript
document.addEventListener('keydown', function(e) {
    if (e.key === 'a' || e.key === 'A') {
        const btnA = document.querySelector('[data-testid="column"]:nth-child(1) button');
        if (btnA) btnA.click();
        e.preventDefault();
    }
    // ... S键和D键类似
});
```

**CSS样式**：
```css
.shortcut-hint {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
}
```

---

## 🧪 测试清单

### 局域网视频测试
- [ ] 本机访问，视频正常加载
- [ ] 同局域网其他设备访问，视频正常加载
- [ ] 检查视频自动播放
- [ ] 检查视频切换正确

### 返回上一题测试
- [ ] 点击"上一题"按钮，显示之前的任务
- [ ] 显示之前的选择（如"之前选择：视频A"）
- [ ] 修改选择后提交成功
- [ ] 自动返回当前任务
- [ ] 数据库中旧记录被删除，新记录被插入
- [ ] 如果没有已评任务，显示提示信息

### 快捷键测试
- [ ] 按A键，选择视频A
- [ ] 按S键，选择视频B
- [ ] 按D键，选择两者相当
- [ ] 大小写都能识别
- [ ] 右下角显示快捷键提示
- [ ] 按钮标签显示快捷键提示

---

## 🚀 启动测试

```powershell
# 1. 停止旧服务
.\lan_stop_compare.ps1

# 2. 重新启动
.\lan_start_compare.ps1

# 3. 在浏览器测试
# - 打开评审员链接
# - 测试快捷键A/S/D
# - 测试上一题功能
# - 在其他设备上测试视频加载
```

---

## 📝 用户体验改进

### 评测效率提升
- **快捷键**：减少鼠标操作，提高评测速度
- **直接提交**：无需二次确认，点击即提交
- **自动跳转**：0.5秒自动加载下一题

### 功能完善
- **重判支持**：可以修改之前的评测
- **状态提示**：显示之前的选择
- **视觉反馈**：快捷键提示固定显示

### 网络优化
- **局域网支持**：多设备同时评测
- **视频缓存破坏**：确保视频正确加载
- **自动播放**：打开即播放，无需手动点击

---

## 🔧 故障排除

### 视频无法加载
```powershell
# 检查视频服务器是否绑定到0.0.0.0
netstat -ano | findstr "8011"

# 应该显示：
# TCP    0.0.0.0:8011           0.0.0.0:0              LISTENING
```

### 快捷键不工作
- 确保没有在输入框中
- 刷新页面重试
- 检查浏览器控制台是否有错误

### 上一题按钮无效
- 确保已经完成至少一个评测
- 检查数据库中是否有comparisons记录

---

## 📦 修改的文件

1. **lan_start_compare.ps1** - 添加 `--bind 0.0.0.0`
2. **app/streamlit_app_compare.py** - 添加重判和快捷键功能

---

**所有功能已完成，可以立即投入使用！** 🎉

